# MAP_INITIAL and MAP_SESSION Creation Endpoints

## Overview

These are the two most important endpoints for the **MapTool → Adamo** direction of the integration. They allow you to create new records in the Oracle Adamo database from your MapTool data.

## Endpoints

### 1. Create MAP_INITIAL Record

**Endpoint:** `POST /adamo/initial`

**Purpose:** Creates a new initial molecule evaluation record in the Oracle Adamo MAP_INITIAL table.

**Content-Type:** `application/json`

#### Request Body

| Field            | Type     | Required | Max Length | Description                                                          | Example                              |
| ---------------- | -------- | -------- | ---------- | -------------------------------------------------------------------- | ------------------------------------ |
| `grNumber`       | string   | ✅ Yes   | 14         | Unique molecule identifier. Format: `GR-YY-NNNNN-B` or `SL-NNNNNN-B` | `"GR-25-0001-1"`                     |
| `evaluationDate` | datetime | No       | -          | Date of evaluation                                                   | `"2025-11-03T10:00:00Z"`             |
| `chemist`        | string   | No       | 50         | Chemist who performed evaluation                                     | `"Smith"`                            |
| `assessor`       | string   | No       | 255        | Person(s) who assessed the molecule                                  | `"Johnson, Williams"`                |
| `dilution`       | string   | No       | 30         | Dilution used                                                        | `"10% in DPG"`                       |
| `evaluationSite` | string   | No       | 2          | Site code where evaluation occurred                                  | `"US"`, `"ZH"`, `"EU"`               |
| `odor0H`         | string   | No       | 500        | Odor description at 0 hours (initial)                                | `"Fresh, citrus notes..."`           |
| `odor4H`         | string   | No       | 255        | Odor description after 4 hours                                       | `"Mellowed citrus..."`               |
| `odor24H`        | string   | No       | 255        | Odor description after 24 hours                                      | `"Woody base..."`                    |
| `comments`       | string   | No       | 1000       | Additional comments                                                  | `"Molecule shows good evolution..."` |
| `createdBy`      | string   | No       | 8          | User creating this record (for audit)                                | `"APIUSER"`                          |

#### Auto-Generated Fields

The following fields are automatically generated by the Oracle database and should NOT be included in your request:

- `mapInitialId` - Primary key (auto-generated via sequence)
- `regNumber` - Extracted from `grNumber` (e.g., "GR-88-0681")
- `batch` - Extracted from `grNumber` (trailing digits)
- `creationDate` - Automatically set to current timestamp
- `lastModifiedDate` - Automatically set to current timestamp

#### Example Request

```json
{
  "grNumber": "GR-25-0001-1",
  "evaluationDate": "2025-11-03T10:00:00Z",
  "chemist": "Smith",
  "assessor": "Johnson, Williams",
  "dilution": "10% in DPG",
  "evaluationSite": "US",
  "odor0H": "Fresh, citrus notes with slight floral undertones, clean and bright initial impression",
  "odor4H": "Mellowed citrus, emerging woody notes, balanced sweetness",
  "odor24H": "Woody base with lingering sweet notes, minimal citrus",
  "comments": "Molecule shows good evolution over time. Consider for CP track evaluation.",
  "createdBy": "APIUSER"
}
```

#### Success Response (201 Created)

```json
{
  "status": "success",
  "message": "MAP_INITIAL record created successfully",
  "table": "MAP_INITIAL",
  "data": {
    "mapInitialId": 123456,
    "grNumber": "GR-25-0001-1",
    "evaluationDate": "2025-11-03T10:00:00Z",
    "chemist": "Smith",
    "assessor": "Johnson, Williams",
    "dilution": "10% in DPG",
    "evaluationSite": "US",
    "odor0H": "Fresh, citrus notes with slight floral undertones, clean and bright initial impression",
    "odor4H": "Mellowed citrus, emerging woody notes, balanced sweetness",
    "odor24H": "Woody base with lingering sweet notes, minimal citrus",
    "creationDate": "2025-11-03T10:00:00Z",
    "createdBy": "APIUSER",
    "lastModifiedDate": "2025-11-03T10:00:00Z",
    "lastModifiedBy": "APIUSER",
    "comments": "Molecule shows good evolution over time. Consider for CP track evaluation.",
    "regNumber": "GR-25-0001",
    "batch": 1
  }
}
```

#### Error Responses

**409 Conflict - GR_NUMBER already exists**

```json
{
  "status": "fail",
  "message": "MAP_INITIAL record with GR_NUMBER 'GR-25-0001-1' already exists",
  "existingId": 123456
}
```

**400 Bad Request - Validation Error**

```json
{
  "status": "fail",
  "message": "Validation failed",
  "errors": [
    "GR_NUMBER is required",
    "Chemist name must be 50 characters or less"
  ]
}
```

**503 Service Unavailable - Oracle Not Configured**

```json
{
  "status": "fail",
  "message": "Oracle not configured"
}
```

---

### 2. Create MAP_SESSION Record

**Endpoint:** `POST /adamo/session`

**Purpose:** Creates a new evaluation session record in the Oracle Adamo MAP_SESSION table.

**Content-Type:** `application/json`

#### Request Body

| Field            | Type     | Required | Max Length | Description                            | Example                                               |
| ---------------- | -------- | -------- | ---------- | -------------------------------------- | ----------------------------------------------------- |
| `stage`          | string   | No       | 20         | Session stage (see valid values below) | `"MAP 1"`                                             |
| `evaluationDate` | datetime | No       | -          | Date of session                        | `"2025-11-03T14:00:00Z"`                              |
| `region`         | string   | No       | 2          | Geographic region                      | `"US"`, `"EU"`, `"AS"`                                |
| `segment`        | string   | No       | 2          | Market segment                         | `"CP"` (Consumer Preference), `"FF"` (Fine Fragrance) |
| `participants`   | string   | No       | 1000       | List of session participants           | `"Johnson, Williams, Brown, Davis"`                   |
| `showInTaskList` | string   | No       | 1          | Flag to show in task list              | `"Y"` or `"N"` (default: `"N"`)                       |
| `subStage`       | integer  | No       | -          | Sub-stage identifier (0-9)             | `1`                                                   |
| `category`       | string   | No       | 2          | Session category                       | `"CP"`, `"FF"`                                        |
| `createdBy`      | string   | No       | 8          | User creating this record (for audit)  | `"APIUSER"`                                           |

#### Valid Stage Values

The `stage` field must be one of the following values (case-insensitive):

- `"MAP 0"` - Initial screening
- `"MAP 1"` - Initial evaluation stage
- `"MAP 2"` - Second evaluation stage
- `"MAP 3"` - Third evaluation stage
- `"ISC"` - International Sensory Committee
- `"FIB"` - Fine Ingredients Bench
- `"FIM"` - Fine Ingredients Meeting
- `"ISC (Quest)"` - ISC Quest evaluation
- `"CARDEX"` - Cardex evaluation
- `"RPMC"` - Regional Product Management Committee

#### Auto-Generated Fields

The following fields are automatically generated by the Oracle database:

- `sessionId` - Primary key (auto-generated via sequence)
- `creationDate` - Automatically set to current timestamp
- `lastModifiedDate` - Automatically set to current timestamp

#### Example Request

```json
{
  "stage": "MAP 1",
  "evaluationDate": "2025-11-03T14:00:00Z",
  "region": "US",
  "segment": "CP",
  "participants": "Johnson, Williams, Brown, Davis",
  "showInTaskList": "Y",
  "subStage": 1,
  "category": "CP",
  "createdBy": "APIUSER"
}
```

#### Success Response (201 Created)

```json
{
  "status": "success",
  "message": "MAP_SESSION record created successfully",
  "table": "MAP_SESSION",
  "data": {
    "sessionId": 5001,
    "stage": "MAP 1",
    "evaluationDate": "2025-11-03T14:00:00Z",
    "region": "US",
    "segment": "CP",
    "participants": "Johnson, Williams, Brown, Davis",
    "showInTaskList": "Y",
    "creationDate": "2025-11-03T14:00:00Z",
    "createdBy": "APIUSER",
    "lastModifiedDate": "2025-11-03T14:00:00Z",
    "lastModifiedBy": "APIUSER",
    "subStage": 1,
    "category": "CP",
    "results": null
  }
}
```

#### Error Responses

**400 Bad Request - Invalid Stage**

```json
{
  "status": "fail",
  "message": "Invalid stage value: 'MAP 5'",
  "validStages": [
    "MAP 0",
    "MAP 1",
    "MAP 2",
    "MAP 3",
    "ISC",
    "FIB",
    "FIM",
    "ISC (Quest)",
    "CARDEX",
    "RPMC"
  ]
}
```

**400 Bad Request - Validation Error**

```json
{
  "status": "fail",
  "message": "Validation failed",
  "errors": ["Region must be 2 characters", "SubStage must be between 0 and 9"]
}
```

**503 Service Unavailable - Oracle Not Configured**

```json
{
  "status": "fail",
  "message": "Oracle not configured"
}
```

---

## Postman Testing Guide

### Setup

1. **Base URL:** `http://localhost:5000` (or your configured port)
2. **Headers:**
   ```
   Content-Type: application/json
   ```

### Test 1: Create MAP_INITIAL

1. Create a new POST request in Postman
2. URL: `http://localhost:5000/adamo/initial`
3. Body → Raw → JSON
4. Copy the content from `test-create-map-initial.json`
5. Click **Send**

Expected: 201 Created with the new record including auto-generated `mapInitialId`, `regNumber`, and `batch`

### Test 2: Create MAP_SESSION

1. Create a new POST request in Postman
2. URL: `http://localhost:5000/adamo/session`
3. Body → Raw → JSON
4. Copy the content from `test-create-map-session.json`
5. Click **Send**

Expected: 201 Created with the new record including auto-generated `sessionId`

### Test 3: Verify Created Records

After creating records, verify them using the existing GET endpoints:

**Get MAP_INITIAL by ID:**

```
GET http://localhost:5000/adamo/initial/{mapInitialId}
```

**Get MAP_INITIAL by GR_NUMBER:**

```
GET http://localhost:5000/adamo/initial/gr/GR-25-0001-1
```

**Get MAP_SESSION by ID:**

```
GET http://localhost:5000/adamo/session/{sessionId}
```

---

## Common Use Cases

### Use Case 1: Create Initial Evaluation from MapTool Molecule

When a new molecule is evaluated in MapTool, create the corresponding MAP_INITIAL record:

```json
{
  "grNumber": "{{moleculeGrNumber}}",
  "evaluationDate": "{{currentDateTime}}",
  "chemist": "{{chemistName}}",
  "assessor": "{{assessorName}}",
  "dilution": "10% in DPG",
  "evaluationSite": "{{site}}",
  "odor0H": "{{initialOdorDescription}}",
  "odor4H": "{{odor4HourDescription}}",
  "odor24H": "{{odor24HourDescription}}",
  "comments": "{{evaluationComments}}",
  "createdBy": "MAPTOOL"
}
```

### Use Case 2: Create Session for Panel Evaluation

When scheduling a new panel session in MapTool:

```json
{
  "stage": "MAP 1",
  "evaluationDate": "{{sessionDateTime}}",
  "region": "{{assessmentRegion}}",
  "segment": "{{assessmentSegment}}",
  "participants": "{{participantsList}}",
  "showInTaskList": "Y",
  "subStage": 1,
  "category": "{{sessionCategory}}",
  "createdBy": "MAPTOOL"
}
```

---

## Integration Notes

### Important Considerations

1. **GR_NUMBER Uniqueness:** Each GR_NUMBER can only exist once in MAP_INITIAL. The endpoint will return a 409 Conflict if you try to create a duplicate.

2. **Auto-Generated Fields:** The Oracle database has triggers that automatically:

   - Extract `REG_NUMBER` from `GR_NUMBER` (e.g., "GR-88-0681" from "GR-88-0681-1")
   - Extract `BATCH` from `GR_NUMBER` (trailing digits)
   - Generate primary keys via sequences
   - Set audit timestamps

3. **Stage Validation:** The `stage` field for MAP_SESSION is validated against a constrained list. If you provide an invalid stage, the API will return the list of valid values.

4. **Date Format:** Use ISO 8601 format for dates: `YYYY-MM-DDTHH:mm:ssZ`

5. **Character Limits:** Pay attention to the maximum field lengths to avoid validation errors.

### Mapping from MapTool to Adamo

**Molecule → MAP_INITIAL:**

- `Molecule.GrNumber` → `MAP_INITIAL.GR_NUMBER`
- `Molecule.ChemistName` → `MAP_INITIAL.CHEMIST`
- `Map1_1MoleculeEvaluation.Odor0h` → `MAP_INITIAL.ODOR0H`
- `Map1_1MoleculeEvaluation.Odor4h` → `MAP_INITIAL.ODOR4H`
- `Map1_1MoleculeEvaluation.Odor24h` → `MAP_INITIAL.ODOR24H`

**Assessment → MAP_SESSION:**

- `Assessment.Stage` → `MAP_SESSION.STAGE`
- `Assessment.DateTime` → `MAP_SESSION.EVALUATION_DATE`
- `Assessment.Region` → `MAP_SESSION.REGION`
- `Assessment.Segment` → `MAP_SESSION.SEGMENT`
- `Map1_1Evaluation.Participants` → `MAP_SESSION.PARTICIPANTS`

---

## Error Handling

### Best Practices

1. **Check for Existing Records:** Before creating a MAP_INITIAL, query the existing record by GR_NUMBER to avoid conflicts.

2. **Validate Input:** Validate field lengths and formats on the client side before sending requests.

3. **Handle 409 Conflicts:** When receiving a 409 error for MAP_INITIAL, you may want to update the existing record instead of creating a new one.

4. **Log Errors:** Capture and log all error responses for troubleshooting.

5. **Retry Logic:** Implement retry logic for 500 errors (database errors), but NOT for 400/409 errors (validation/conflict errors).

### Sample Error Handling (Pseudocode)

```javascript
try {
  const response = await createMapInitial(data);

  if (response.status === 201) {
    console.log("Created successfully:", response.data.mapInitialId);
  } else if (response.status === 409) {
    console.log("Record already exists:", response.existingId);
    // Consider UPDATE instead of CREATE
  } else if (response.status === 400) {
    console.error("Validation failed:", response.errors);
    // Fix validation errors
  }
} catch (error) {
  console.error("Network or server error:", error);
  // Retry or alert
}
```

---

## Next Steps

After successfully creating MAP_INITIAL and MAP_SESSION records, you may want to:

1. **Create MAP_RESULT records** linked to the session
2. **Create ODOR_CHARACTERIZATION records** for detailed odor profiling
3. **Query the created records** to verify the data
4. **Link sessions** using MAP1_SESSION_LINK for CP/FF relationships

---

## Support

For questions or issues:

1. Check the [API_USAGE_EXAMPLES.md](../guides/API_USAGE_EXAMPLES.md) for more examples
2. Review [ALL_ENDPOINTS.md](../reference/ALL_ENDPOINTS.md) for complete endpoint reference
3. Consult [adamo-DATABASE_STRUCTURE.md](../setup/adamo-DATABASE_STRUCTURE.md) for database details
